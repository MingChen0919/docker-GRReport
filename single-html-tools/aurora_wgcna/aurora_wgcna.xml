<tool id="aurora_wgcna" name="WGCNA" version="1.0.0">
    <description>
        Identify gene co-expression network modules using WGCNA.
    </description>
    <requirements>
        <requirement type="package" version="2.7.3">pandoc</requirement>
        <requirement type="package" version="1.20.3">r-getopt</requirement>
        <requirement type="package" version="1.12">r-rmarkdown</requirement>
        <requirement type="package" version="1.8.4">r-plyr</requirement>
        <requirement type="package" version="0.4">r-dt</requirement>
        <requirement type="package" version="0.4.0">r-htmltools</requirement>
        <requirement type="package" version="1.68">r-wgcna</requirement>
    </requirements>
    <stdio>
        <regex match="Execution halted"
               source="both"
               level="fatal"
               description="Execution halted." />
        <regex match="Error in"
               source="both"
               level="fatal"
               description="An undefined error occured, please check your intput carefully and contact your administrator." />
        <regex match="Fatal error"
               source="both"
               level="fatal"
               description="An undefined error occured, please check your intput carefully and contact your administrator." />
    </stdio>
    <command>
        <![CDATA[
        export TOOL_INSTALL_DIR='${__tool_directory__}' &&

        Rscript '${__tool_directory__}/aurora_wgcna_render.R'
            #if $height_cut
              -h $height_cut
            #end if
            #if $soft_threshold_power
              -p $soft_threshold_power
            #end if
            -e $expression_data
            -t $trait_data
            -r $report_html
            -g $genes_info_file
            -m $modules_info_file
        ]]>
    </command>
    <inputs>
        <param
          type="float"
          value=""
          name="height_cut"
          optional="true"
          label="Height"
          help="Refer to the sample clustering plot from WGCNA: preprocessing and choose a height cut that will remove outliers. If there is not outlier, leave this field blank."
        />
        <param
          type="data"
          name="expression_data"
          format="csv"
          optional="false"
          label="Gene expression data"
          help="Each row represents a gene and each column represents a sample."
        />
        <param
          type="data"
          name="trait_data"
          format="csv"
          optional="false"
          label="Sample Annotation data"
          help="The sample annotation data is an n x m matrix where n is the samples and m are the features such as experimental condition, biosample properties, traits or phenotype values.  The matrix should be stored in a comma-separated (CSV) file. It must have a header."
        />
        <param
          type="integer"
          value=""
          name="soft_threshold_power"
          optional="true"
          label="Soft threshold power"
          help="Refer to the scale independence plot from 'WGCNA: construct network' and choose an optimal soft threshold power. An optimal power will be calculated automatically if no value is provided."
        />
    </inputs>
    <outputs>
        <data
          name="report_html"
          format="html"
          label="wgcna_analysis_report"
        />
        <data
          name="genes_info_file"
          format="csv"
          label="wgcna_analysis_genes"
        />
        <data
          name="modules_info_file"
          format="csv"
          label="wgcna_analysis_modules"
        />
    </outputs>
    <tests>
        <test>
          <param name='expression_data' value="LiverFemale3600.gem.csv"/>
          <param name='trait_data' value="ClinicalTraits.csv"/>
          <output name="genes_info_file" file="wgcna_analysis_genes.csv"/>
          <output name="report_html" file="wgcna_analysis_report.html"/>
          <output name="modules_info_file" file="wgcna_analysis_report.csv"/>
        </test>
    </tests>
    <help><![CDATA[
      This tool is a wrapper for the WGCNA R library.  Please see the online
      WGCNA tutorial for further details.
      ]]>
    </help>
    <citations>
        <citation type="bibtex">
            @article{langfelder2008wgcna,
            title={WGCNA: an R package for weighted correlation network analysis},
            author={Langfelder, Peter and Horvath, Steve},
            journal={BMC bioinformatics},
            volume={9},
            number={1},
            pages={559},
            year={2008},
            publisher={BioMed Central}
            }
        </citation>
        <citation type="bibtex">
            @article{allaire2016rmarkdown,
            title={rmarkdown: Dynamic Documents for R, 2016},
            author={Allaire, J and Cheng, Joe and Xie, Yihui and McPherson, Jonathan and Chang, Winston and Allen, Jeff and Wickham, Hadley and Atkins, Aron and Hyndman, Rob},
            journal={R package version 0.9},
            volume={6},
            year={2016}
            }
        </citation>
        <citation type="bibtex">
            @book{xie2015dynamic,
            title={Dynamic Documents with R and knitr},
            author={Xie, Yihui},
            volume={29},
            year={2015},
            publisher={CRC Press}
            }
        </citation>
        <citation  type="bibtex">
            @misc{dt2016,
            title = {DT: A Wrapper of the JavaScript Library 'DataTables'},
            author = {Yihui Xie},
            year = {2016},
            note = {R package version 0.2},
            url = {https://CRAN.R-project.org/package=DT},
            }
        </citation>
    </citations>
</tool>
